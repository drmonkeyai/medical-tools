// src/calculators/who/whoCvdSea.ts
// WHO CVD Risk Charts — Southeast Asia (laboratory-based + non-laboratory-based)
// Source: WHO cardiovascular disease risk charts (Southeast Asia) — see PDF in project.

/**
 * Index conventions in all arrays below:
 * - ageIdx: 0..6 = 70–74, 65–69, 60–64, 55–59, 50–54, 45–49, 40–44
 * - sbpIdx: 0..4 = ≥180, 160–179, 140–159, 120–139, <120
 * - tcIdx:  0..4 = <4, 4–4.9, 5–5.9, 6–6.9, ≥7 (mmol/L)
 * - bmiIdx: 0..4 = <20, 20–24, 25–29, 30–35, ≥35 (kg/m²)
 * - sexIdx: 0=men, 1=women
 * - smokerIdx: 0=non-smoker, 1=smoker
 * - dmIdx (lab only): 0=no diabetes, 1=diabetes
 */

export const WHO_SEA_AGE_BANDS = ["70-74","65-69","60-64","55-59","50-54","45-49","40-44"] as const;
export const WHO_SEA_SBP_BANDS = ["≥180","160-179","140-159","120-139","<120"] as const;
export const WHO_SEA_TC_BANDS = ["<4","4-4.9","5-5.9","6-6.9","≥7"] as const;
export const WHO_SEA_BMI_BANDS = ["<20","20-24","25-29","30-35","≥35"] as const;

// LAB-based: [dmIdx][sexIdx][smokerIdx][ageIdx][sbpIdx][tcIdx] => risk (%)
export const WHO_SEA_LAB: number[][][][][][] = [[[[[[24,26,29,32,35],[19,20,22,25,28],[15,16,18,20,23],[12,13,15,17,19],[10,11,12,14,15]],[[19,20,22,25,28],[15,16,18,20,22],[12,13,15,17,19],[10,11,12,14,15],[8,9,10,11,13]],[[15,16,18,20,23],[12,13,15,17,19],[10,11,12,14,15],[8,9,10,11,13],[7,7,8,9,10]],[[12,13,15,17,19],[10,11,12,14,15],[8,9,10,11,13],[7,7,8,9,10],[5,6,6,7,8]],[[10,11,12,14,15],[8,9,10,11,13],[7,7,8,9,10],[5,6,6,7,8],[4,4,5,5,6]],[[8,9,10,11,13],[7,7,8,9,10],[5,6,6,7,8],[4,4,5,5,6],[3,3,3,4,4]],[[7,7,8,9,10],[5,6,6,7,8],[4,4,5,5,6],[3,3,3,4,4],[2,2,2,3,3]]],[[[30,33,37,41,46],[24,26,30,34,38],[19,21,24,27,30],[15,17,19,22,24],[13,14,16,18,20]],[[24,26,30,34,38],[19,21,24,27,30],[15,17,19,22,24],[13,14,16,18,20],[10,11,13,14,16]],[[19,21,24,27,30],[15,17,19,22,24],[13,14,16,18,20],[10,11,13,14,16],[8,9,10,11,12]],[[15,17,19,22,24],[13,14,16,18,20],[10,11,13,14,16],[8,9,10,11,12],[6,7,7,8,9]],[[13,14,16,18,20],[10,11,13,14,16],[8,9,10,11,12],[6,7,7,8,9],[5,5,6,6,7]],[[10,11,13,14,16],[8,9,10,11,12],[6,7,7,8,9],[5,5,6,6,7],[3,4,4,4,5]],[[8,9,10,11,12],[6,7,7,8,9],[5,5,6,6,7],[3,4,4,4,5],[3,3,3,3,4]]]],[[[[22,24,26,29,33],[18,19,21,24,27],[14,15,17,19,22],[11,12,14,16,18],[9,10,11,12,14]],[[18,19,21,24,27],[14,15,17,19,22],[11,12,14,16,18],[9,10,11,12,14],[7,7,8,9,10]],[[14,15,17,19,22],[11,12,14,16,18],[9,10,11,12,14],[7,7,8,9,10],[6,6,6,7,8]],[[11,12,14,16,18],[9,10,11,12,14],[7,7,8,9,10],[6,6,6,7,8],[4,5,5,6,6]],[[9,10,11,12,14],[7,7,8,9,10],[6,6,6,7,8],[4,5,5,6,6],[3,3,4,4,5]],[[7,7,8,9,10],[6,6,6,7,8],[4,5,5,6,6],[3,3,4,4,5],[2,2,2,3,3]],[[6,6,6,7,8],[4,5,5,6,6],[3,3,4,4,5],[2,2,2,3,3],[2,2,2,2,2]]],[[[27,30,34,38,42],[22,24,27,31,35],[18,19,22,25,28],[14,15,17,19,22],[12,13,14,15,17]],[[22,24,27,31,35],[18,19,22,25,28],[14,15,17,19,22],[12,13,14,15,17],[9,10,11,12,13]],[[18,19,22,25,28],[14,15,17,19,22],[12,13,14,15,17],[9,10,11,12,13],[7,8,8,9,10]],[[14,15,17,19,22],[12,13,14,15,17],[9,10,11,12,13],[7,8,8,9,10],[5,6,6,6,7]],[[12,13,14,15,17],[9,10,11,12,13],[7,8,8,9,10],[5,6,6,6,7],[4,4,4,5,5]],[[9,10,11,12,13],[7,8,8,9,10],[5,6,6,6,7],[4,4,4,5,5],[3,3,3,3,4]],[[7,8,8,9,10],[5,6,6,6,7],[4,4,4,5,5],[3,3,3,3,4],[2,2,2,2,3]]]]],[[[[[30,33,37,41,46],[24,26,30,34,38],[19,21,24,27,30],[15,17,19,22,24],[13,14,16,18,20]],[[24,26,30,34,38],[19,21,24,27,30],[15,17,19,22,24],[13,14,16,18,20],[10,11,13,14,16]],[[19,21,24,27,30],[15,17,19,22,24],[13,14,16,18,20],[10,11,13,14,16],[8,9,10,11,12]],[[15,17,19,22,24],[13,14,16,18,20],[10,11,13,14,16],[8,9,10,11,12],[6,7,7,8,9]],[[13,14,16,18,20],[10,11,13,14,16],[8,9,10,11,12],[6,7,7,8,9],[5,5,6,6,7]],[[10,11,13,14,16],[8,9,10,11,12],[6,7,7,8,9],[5,5,6,6,7],[3,4,4,4,5]],[[8,9,10,11,12],[6,7,7,8,9],[5,5,6,6,7],[3,4,4,4,5],[3,3,3,3,4]]],[[[35,39,43,48,52],[29,32,36,40,44],[24,26,30,33,37],[19,21,24,27,30],[16,17,19,21,24]],[[29,32,36,40,44],[24,26,30,33,37],[19,21,24,27,30],[16,17,19,21,24],[13,14,15,17,18]],[[24,26,30,33,37],[19,21,24,27,30],[16,17,19,21,24],[13,14,15,17,18],[10,11,11,12,13]],[[19,21,24,27,30],[16,17,19,21,24],[13,14,15,17,18],[10,11,11,12,13],[8,8,9,9,10]],[[16,17,19,21,24],[13,14,15,17,18],[10,11,11,12,13],[8,8,9,9,10],[6,6,6,7,7]],[[13,14,15,17,18],[10,11,11,12,13],[8,8,9,9,10],[6,6,6,7,7],[4,4,4,4,5]],[[10,11,11,12,13],[8,8,9,9,10],[6,6,6,7,7],[4,4,4,4,5],[3,3,3,3,4]]]],[[[[27,30,34,38,42],[22,24,27,31,35],[18,19,22,25,28],[14,15,17,19,22],[12,13,14,15,17]],[[22,24,27,31,35],[18,19,22,25,28],[14,15,17,19,22],[12,13,14,15,17],[9,10,11,12,13]],[[18,19,22,25,28],[14,15,17,19,22],[12,13,14,15,17],[9,10,11,12,13],[7,8,8,9,10]],[[14,15,17,19,22],[12,13,14,15,17],[9,10,11,12,13],[7,8,8,9,10],[5,6,6,6,7]],[[12,13,14,15,17],[9,10,11,12,13],[7,8,8,9,10],[5,6,6,6,7],[4,4,4,5,5]],[[9,10,11,12,13],[7,8,8,9,10],[5,6,6,6,7],[4,4,4,5,5],[3,3,3,3,4]],[[7,8,8,9,10],[5,6,6,6,7],[4,4,4,5,5],[3,3,3,3,4],[2,2,2,2,3]]],[[[32,36,41,45,50],[27,30,34,38,43],[22,24,27,31,35],[18,19,22,25,28],[15,16,18,20,22]],[[27,30,34,38,43],[22,24,27,31,35],[18,19,22,25,28],[15,16,18,20,22],[12,13,14,15,17]],[[22,24,27,31,35],[18,19,22,25,28],[15,16,18,20,22],[12,13,14,15,17],[9,10,10,11,12]],[[18,19,22,25,28],[15,16,18,20,22],[12,13,14,15,17],[9,10,10,11,12],[7,7,8,8,9]],[[15,16,18,20,22],[12,13,14,15,17],[9,10,10,11,12],[7,7,8,8,9],[5,5,6,6,6]],[[12,13,14,15,17],[9,10,10,11,12],[7,7,8,8,9],[5,5,6,6,6],[4,4,4,4,5]],[[9,10,10,11,12],[7,7,8,8,9],[5,5,6,6,6],[4,4,4,4,5],[3,3,3,3,4]]]]]];

// Non-lab BMI-based: [sexIdx][smokerIdx][ageIdx][sbpIdx][bmiIdx] => risk (%)
export const WHO_SEA_BMI: number[][][][][] = [[[[[21,24,26,29,31],[16,18,21,23,25],[13,14,16,18,20],[10,11,12,13,14],[8,9,10,11,12]],[[16,18,21,23,25],[13,14,16,18,20],[10,11,12,13,14],[8,9,10,11,12],[6,7,7,8,9]],[[13,14,16,18,20],[10,11,12,13,14],[8,9,10,11,12],[6,7,7,8,9],[5,5,6,6,7]],[[10,11,12,13,14],[8,9,10,11,12],[6,7,7,8,9],[5,5,6,6,7],[4,4,4,5,5]],[[8,9,10,11,12],[6,7,7,8,9],[5,5,6,6,7],[4,4,4,5,5],[3,3,3,3,4]],[[6,7,7,8,9],[5,5,6,6,7],[4,4,4,5,5],[3,3,3,3,4],[2,2,2,2,3]],[[5,5,6,6,7],[4,4,4,5,5],[3,3,3,3,4],[2,2,2,2,3],[1,1,1,1,2]]],[[[27,30,34,37,40],[21,23,26,29,32],[16,18,21,23,25],[13,14,16,18,20],[11,12,13,14,15]],[[21,23,26,29,32],[16,18,21,23,25],[13,14,16,18,20],[11,12,13,14,15],[8,9,10,11,12]],[[16,18,21,23,25],[13,14,16,18,20],[11,12,13,14,15],[8,9,10,11,12],[6,7,7,8,9]],[[13,14,16,18,20],[11,12,13,14,15],[8,9,10,11,12],[6,7,7,8,9],[5,5,6,6,7]],[[11,12,13,14,15],[8,9,10,11,12],[6,7,7,8,9],[5,5,6,6,7],[4,4,4,5,5]],[[8,9,10,11,12],[6,7,7,8,9],[5,5,6,6,7],[4,4,4,5,5],[3,3,3,3,4]],[[6,7,7,8,9],[5,5,6,6,7],[4,4,4,5,5],[3,3,3,3,4],[2,2,2,2,3]]]],[[[[17,19,21,23,25],[13,14,16,18,20],[10,11,12,13,14],[8,9,10,11,12],[6,7,7,8,9]],[[13,14,16,18,20],[10,11,12,13,14],[8,9,10,11,12],[6,7,7,8,9],[5,5,6,6,7]],[[10,11,12,13,14],[8,9,10,11,12],[6,7,7,8,9],[5,5,6,6,7],[4,4,4,5,5]],[[8,9,10,11,12],[6,7,7,8,9],[5,5,6,6,7],[4,4,4,5,5],[3,3,3,3,4]],[[6,7,7,8,9],[5,5,6,6,7],[4,4,4,5,5],[3,3,3,3,4],[2,2,2,2,3]],[[5,5,6,6,7],[4,4,4,5,5],[3,3,3,3,4],[2,2,2,2,3],[1,1,1,1,2]],[[4,4,4,5,5],[3,3,3,3,4],[2,2,2,2,3],[1,1,1,1,2],[1,1,1,1,1]]],[[[22,25,28,31,34],[17,19,21,23,25],[13,14,16,18,20],[10,11,12,13,14],[8,9,10,11,12]],[[17,19,21,23,25],[13,14,16,18,20],[10,11,12,13,14],[8,9,10,11,12],[6,7,7,8,9]],[[13,14,16,18,20],[10,11,12,13,14],[8,9,10,11,12],[6,7,7,8,9],[5,5,6,6,7]],[[10,11,12,13,14],[8,9,10,11,12],[6,7,7,8,9],[5,5,6,6,7],[4,4,4,5,5]],[[8,9,10,11,12],[6,7,7,8,9],[5,5,6,6,7],[4,4,4,5,5],[3,3,3,3,4]],[[6,7,7,8,9],[5,5,6,6,7],[4,4,4,5,5],[3,3,3,3,4],[2,2,2,2,3]],[[5,5,6,6,7],[4,4,4,5,5],[3,3,3,3,4],[2,2,2,2,3],[1,1,1,1,2]]]]];

export function clampInt(v: number, min: number, max: number) {
  return Math.min(max, Math.max(min, Math.trunc(v)));
}

export function ageToBandIdx(ageYears: number): number {
  // WHO charts are for 40–74; clamp into nearest band
  if (!Number.isFinite(ageYears)) return 6;
  if (ageYears >= 70) return 0;
  if (ageYears >= 65) return 1;
  if (ageYears >= 60) return 2;
  if (ageYears >= 55) return 3;
  if (ageYears >= 50) return 4;
  if (ageYears >= 45) return 5;
  return 6;
}

export function sbpToBandIdx(sbp: number): number {
  if (!Number.isFinite(sbp)) return 4;
  if (sbp >= 180) return 0;
  if (sbp >= 160) return 1;
  if (sbp >= 140) return 2;
  if (sbp >= 120) return 3;
  return 4;
}

export function tcToBandIdx(tcMmolL: number): number {
  if (!Number.isFinite(tcMmolL)) return 2;
  if (tcMmolL < 4) return 0;
  if (tcMmolL < 5) return 1;
  if (tcMmolL < 6) return 2;
  if (tcMmolL < 7) return 3;
  return 4;
}

export function bmiToBandIdx(bmi: number): number {
  if (!Number.isFinite(bmi)) return 2;
  if (bmi < 20) return 0;
  if (bmi < 25) return 1;
  if (bmi < 30) return 2;
  if (bmi < 35) return 3;
  return 4;
}

export type WhoRiskBand = "<5%" | "5–<10%" | "10–<20%" | "20–<30%" | "≥30%";

export function riskToBand(riskPct: number): WhoRiskBand {
  if (!Number.isFinite(riskPct)) return "10–<20%";
  if (riskPct < 5) return "<5%";
  if (riskPct < 10) return "5–<10%";
  if (riskPct < 20) return "10–<20%";
  if (riskPct < 30) return "20–<30%";
  return "≥30%";
}

export function whoSeaRiskLab(args: {
  sex: "male" | "female";
  smoker: boolean;
  diabetes: boolean;
  ageYears: number;
  sbp: number;
  tcMmolL: number;
}): number {
  const dmIdx = args.diabetes ? 1 : 0;
  const sexIdx = args.sex === "female" ? 1 : 0;
  const smokerIdx = args.smoker ? 1 : 0;
  const ageIdx = ageToBandIdx(args.ageYears);
  const sbpIdx = sbpToBandIdx(args.sbp);
  const tcIdx = tcToBandIdx(args.tcMmolL);
  return WHO_SEA_LAB[dmIdx][sexIdx][smokerIdx][ageIdx][sbpIdx][tcIdx];
}

export function whoSeaRiskBmi(args: {
  sex: "male" | "female";
  smoker: boolean;
  ageYears: number;
  sbp: number;
  bmi: number;
}): number {
  const sexIdx = args.sex === "female" ? 1 : 0;
  const smokerIdx = args.smoker ? 1 : 0;
  const ageIdx = ageToBandIdx(args.ageYears);
  const sbpIdx = sbpToBandIdx(args.sbp);
  const bmiIdx = bmiToBandIdx(args.bmi);
  return WHO_SEA_BMI[sexIdx][smokerIdx][ageIdx][sbpIdx][bmiIdx];
}
